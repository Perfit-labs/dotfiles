#!/bin/bash

set -e

if [[ -z $1 ]]; then
  SESSION=$(basename $PWD);
else
  SESSION=$1
fi

# Checks to see if an executable exists and then
# creates a window for it
#
# example:
#   _safe_window console script/console
_safe_window() {
  if [[ -x $2 ]]; then
    tmux new-window -n $1 -t $SESSION
    local WINDOW_NUMBER=$(tmux list-windows | tail -n1 | cut -d':' -f1)
    tmux send-keys -t $SESSION:$WINDOW_NUMBER $2 C-m
    tmux rename-window -t $SESSION:$WINDOW_NUMBER $1
  fi
}

if ! (tmux has-session -t $SESSION >/dev/null 2>&1); then
  if [[ -x $PWD/.tmux ]]; then
    # load project-specific layout if found
    $PWD/.tmux
  else
    tmux new-session -s $SESSION -n vim -d
    tmux new-window -n shell -t $SESSION
    tmux rename-window -t $SESSION:2 shell

    tmux send-keys -t $SESSION:1 'vim' C-m #':CtrlP' C-m
    _safe_window console script/console
    _safe_window server script/server

    tmux select-window -t $SESSION:1
  fi

fi

tmux attach -t $SESSION

