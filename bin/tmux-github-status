#!/bin/sh
set -e

INDICATOR=" â¬¤"
CURRENT_STATUS=$(tmux show-options | grep status-left-fg | grep -Eio '(red|green|yellow)')
STATUS_URL="https://status.github.com/api"
GITHUB_STATUS=$(curl $STATUS_URL/status.json | jq -r '.status')

case $GITHUB_STATUS in
  major)
    NEW_STATUS="red" ;;
  minor)
    NEW_STATUS="yellow" ;;
  *)
    NEW_STATUS="green";;
esac

tmux set-option status-left-fg $NEW_STATUS
tmux set-option status-left "$INDICATOR"

if [ "$NEW_STATUS" != "$CURRENT_STATUS" ]; then
  MESSAGE="$(curl $STATUS_URL/last-message.json | jq -r '.body')"
  tmux set-option message-bg $NEW_STATUS
  tmux display-message " $MESSAGE"
  # make sure message exits first
  sleep 5
  tmux set-option -u message-bg
  tmux set-option -u message-fg
fi
